
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Property-based testing in Ruby - Troika Tech</title>
  <meta name="author" content="Vitor Capela">

  
  <meta name="description" content="For the past year or so I have slowly been dipping my feet into the vast functional programming seas. From taking the awesome Coursera offerings from &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://troikatech.com/blog/2014/04/02/property-based-testing-in-ruby">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Troika Tech" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript" src="//use.typekit.net/ksw3xzi.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-47043795-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Troika Tech</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:troikatech.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Property-based Testing in Ruby</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-02T10:32:00-03:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>For the past year or so I have slowly been dipping my feet into the vast functional programming seas. From taking the awesome <a href="http://coursera.org">Coursera</a> <a href="https://www.coursera.org/course/progfun">offerings</a> <a href="https://www.coursera.org/course/reactive">from Typesafe</a> to slowly working through RÃºnar Bjarnason&rsquo;s and Paul Chiusano&rsquo;s <em><a href="http://www.manning.com/bjarnason/">Functional Programming in Scala</a></em>, my mind has been expanding proportionally to the time I dedicate to learning its ways. It has been incredibly rewarding and humbling.</p>

<p>One such reward has been coming into direct touch with property-based testing. This technique, first developed by <a href="http://en.wikipedia.org/wiki/QuickCheck">QuickCheck</a> in Haskell-land, spins automated testing on its head: instead of codifying what is proper behavior by asserting that the outputs for given inputs match what is expected, the tester establishes logical properties about what should happen and lets the tool generate loads of inputs to check if they hold. If something goes wrong, the tool will then try to find the smallest test input that breaks the property (<em>falsifies</em> it), a process called <em>shrinking</em>; if it can&rsquo;t find anything, you can sigh with relief and think about what to scrutinize next.</p>

<p>Having a QuickCheck-like tool at your disposal can be incredibly powerful. The more complex the software or the algorithm, the greater the likelihood of your carefully curated unit and integration tests having blind spots. <a href="http://basho.com">Basho</a>, for instance, <a href="http://basho.com/quickchecking-poolboy-for-fun-and-profit/">have written about the stark realization that their worker pool library was full of subtle bugs by using QuickCheck for Erlang</a>, and you can find <a href="http://www.quviq.com/documents/erlang001-arts.pdf">other</a> <a href="http://www.autosar.org/download/conferencedocs11/12_AUTOSAR_ModelBased_Quviq.pdf">instances</a> of how the technique helped make better software.</p>

<p>I don&rsquo;t know about you, but when I come in contact with stuff like that I immediately think of how improved parts of my day job would be if I just could apply it. Considering that my daily duties are conducted in Ruby, I felt it was time I explored the subject in that realm.</p>

<h2>A contrived setup that hopefully shows how it can work out</h2>

<p>Let&rsquo;s say we&rsquo;ve decided to implement our own linked list class in Ruby. We would probably start our implementation with something like this:</p>

<figure class='code'><figcaption><span>&#8220;List&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;singleton&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Nil</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">empty?</span><span class="p">;</span> <span class="kp">true</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="s2">&quot;Nil&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Cons</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@head</span> <span class="o">=</span> <span class="n">head</span>
</span><span class='line'>    <span class="vi">@tail</span> <span class="o">=</span> <span class="n">tail</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:head</span><span class="p">,</span> <span class="ss">:tail</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">empty?</span><span class="p">;</span> <span class="kp">false</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="s2">&quot;(</span><span class="si">#{</span><span class="n">head</span><span class="si">}</span><span class="s2"> . </span><span class="si">#{</span><span class="n">tail</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using that <em>very</em> convenient API, we can build lists:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)))</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="n">l</span><span class="o">.</span><span class="n">to_s</span> <span class="c1"># =&gt; &quot;(1 . (2 . (3 . Nil)))&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We know that, in a linked list, adding to the head is O(1), while appending to the end is O(n). So we build algorithms that respect its efficiency guarantees. However, when we, say, map this list into another list, it results in the following situation:</p>

<figure class='code'><figcaption><span>&#8220;List&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">do_something_amazing</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>  <span class="n">super_value</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="n">head</span> <span class="o">*</span> <span class="mi">1337</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">acc</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">do_something_amazing</span><span class="p">(</span><span class="n">list</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">super_value</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="n">do_something</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="c1"># =&gt; &quot;(4011 . (2674 . (1337 . Nil)))&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Processing things from head to tail means the list ends up reversed. It&rsquo;s common, then, to reverse it back when we&rsquo;re done processing, to preserve the order an external user would expect. Let&rsquo;s add a <code>reverse</code> method to a <code>List</code> helper module:</p>

<figure class='code'><figcaption><span>&#8220;List&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">List</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">reverse</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">list</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="n">acc</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">reverse</span><span class="p">(</span><span class="n">list</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">list</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So when we try to reverse what was created in <code>do_something_amazing</code>, we get what we need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">do_something_amazing</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span> <span class="c1"># =&gt; &quot;(1337 . (2674 . (4011 . Nil)))&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome. I think this is enough for us to start exploring properties. If you&rsquo;re getting bored, take a sip of coffee and come back when you&rsquo;re ready. There&rsquo;s a few cool tricks below the fold.</p>

<h2>Testing the old way</h2>

<p>Being the good developers we are, we are covering that code with tests:</p>

<figure class='code'><figcaption><span>&#8220;List Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ListTest</span> <span class="o">&lt;</span> <span class="ss">MiniTest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_reversing_lists</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(3 . (2 . (1 . Nil)))&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(9 . (400 . (321 . (1 . (10 . Nil)))))&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">321</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">9</span><span class="p">))))))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Nil&quot;</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(1 . Nil)&quot;</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re pretty confident that&rsquo;s enough, even if it was kind of boring to do manually. That amount of testing would let us go home and sleep soundly.</p>

<h2>Testing the QuickCheck way</h2>

<p>First, we&rsquo;ll need something like QuickCheck in Ruby. The best, most idiomatic, most maintained, least-Monad-y thing I have found is <a href="https://github.com/hayeah/rantly">Rantly</a>. It has both primitive value generation built-in and property testing with shrinking. We&rsquo;ll skip over the basic API and go straight to defining a property to check if my algorithm is really bullet-proof. To aid in the creation of lists from Arrays, we&rsquo;ll add a new helper:</p>

<figure class='code'><figcaption><span>&#8220;List&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">List</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_values</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
</span><span class='line'>    <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">ls</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To check that it works, let&rsquo;s change the existing tests and see if they still pass:</p>

<figure class='code'><figcaption><span>&#8220;List Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ListTest</span> <span class="o">&lt;</span> <span class="ss">MiniTest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_reversing_lists</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(3 . (2 . (1 . Nil)))&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(9 . (400 . (321 . (1 . (10 . Nil)))))&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">321</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Nil&quot;</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;(1 . Nil)&quot;</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>&#8220;List Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">48889</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">001256</span><span class="n">s</span><span class="p">,</span> <span class="mi">796</span><span class="o">.</span><span class="mi">1783</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">3184</span><span class="o">.</span><span class="mi">7134</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">4</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great. Now to the newfangled thing. As I mentioned before, writing a property to check requires us to think differently than we would with regular unit tests. Your formulation should state something logical, something that does not rely on specific inputs. Following that guideline, we can reason about reversing lists in the following manner:</p>

<figure class='code'><figcaption><span>&#8220;List Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list2_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_reversing_by_property</span>
</span><span class='line'>    <span class="n">property</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">length</span> <span class="o">=</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span class='line'>      <span class="no">List</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span> <span class="n">integer</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">check</span> <span class="p">{</span> <span class="o">|</span><span class="n">list</span><span class="o">|</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="n">list</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">list</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The meat is in the <code>check</code> block. Determining that a list has been reversed correctly requires us to check if reversing it again gets us back to the original list. To seed our check, we build a <code>property</code> block that creats an array with a random length between 0 and 1_000_000, itself filled with random integers. Let&rsquo;s run the tests again:</p>

<figure class='code'><figcaption><span>&#8220;List Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list2_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">ruby</span> <span class="n">list</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">17130</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">121</span><span class="o">.</span><span class="mi">969127</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mo">0164</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">8527</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">104</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>It took a while (we wanted to be thorough, with those million-item arrays), but we&rsquo;re pretty sure it works. I&rsquo;m a believer and I&rsquo;m stoked; when I look at you, however, I see a face that says &ldquo;look, it&rsquo;s cool and all, but isn&rsquo;t it <em>kind of worthless</em>? The tests we had were telling us the same thing, and we only needed the power of our minds to generate the correct inputs. Why go through so much trouble?&rdquo;</p>

<p>Well, what about those times when ours minds fail us?</p>

<h2>Catching a bug with Rantly</h2>

<p>Let&rsquo;s say you&rsquo;re excited about building your own data structures and want to wrap that linked list inside a very inefficient Set. You mutter to yourself that you should make sure items are not inserted twice, which for now seems to be the main difference between Sets and Lists as storage containers.</p>

<p>You build a little more structure into what you already have, adding a <code>prepend</code> method and inlining <code>reverse</code> into a <code>List</code> base class:</p>

<figure class='code'><figcaption><span>&#8220;List 2&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list2-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">List</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Don&#39;t use this directly, fool&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">empty?</span><span class="p">;</span> <span class="kp">true</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">prepend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="n">acc</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">empty?</span>
</span><span class='line'>      <span class="n">acc</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">tail</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_values</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
</span><span class='line'>    <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">ls</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="no">Cons</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Nil</span> <span class="o">&lt;</span> <span class="no">List</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="s2">&quot;Nil&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Cons</span> <span class="o">&lt;</span> <span class="no">List</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@head</span> <span class="o">=</span> <span class="n">head</span>
</span><span class='line'>    <span class="vi">@tail</span> <span class="o">=</span> <span class="n">tail</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:head</span><span class="p">,</span> <span class="ss">:tail</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">empty?</span><span class="p">;</span> <span class="kp">false</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="s2">&quot;(</span><span class="si">#{</span><span class="n">head</span><span class="si">}</span><span class="s2"> . </span><span class="si">#{</span><span class="n">tail</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To check if an item exists, you add a <code>contains?</code> method:</p>

<figure class='code'><figcaption><span>&#8220;List with contains&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-list2-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">List</span>
</span><span class='line'>  <span class="c1"># ..</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">);</span> <span class="kp">false</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ..</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Cons</span> <span class="o">&lt;</span> <span class="no">List</span>
</span><span class='line'>  <span class="c1"># ..</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="n">head</span> <span class="o">==</span> <span class="n">v</span> <span class="o">||</span> <span class="n">tail</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ..</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you write your immutable Set and matching tests:</p>

<figure class='code'><figcaption><span>&#8220;A dumb set implementation&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-set-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DumbSet</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">storage</span> <span class="o">=</span> <span class="no">Nil</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@storage</span> <span class="o">=</span> <span class="n">storage</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:storage</span>
</span><span class='line'>  <span class="kp">private</span>     <span class="ss">:storage</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">storage</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>      <span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:&lt;&lt;</span><span class="p">,</span> <span class="ss">:push</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="n">storage</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_a</span>
</span><span class='line'>    <span class="n">values</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">list</span>   <span class="o">=</span> <span class="n">storage</span>
</span><span class='line'>    <span class="k">until</span> <span class="n">list</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="n">list</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>      <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="n">tail</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">values</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DumbSetTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@s</span> <span class="o">=</span> <span class="p">(((</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:s</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_contains</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_uniqueness</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[-</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And because I spotted you writing new code and yelled &ldquo;HEY USE RANTLY IT&rsquo;S SO COOL YIPEE&rdquo;, you add some property tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DumbSetTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">def</span> <span class="nf">test_contains_property</span>
</span><span class='line'>    <span class="n">property</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">array</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span> <span class="n">integer</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">check</span> <span class="p">{</span> <span class="o">|</span><span class="n">vs</span><span class="o">|</span>
</span><span class='line'>      <span class="n">s</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">ds</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">ds</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">assert</span> <span class="n">vs</span><span class="o">.</span><span class="n">all?</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">contains?</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_uniqueness_property</span>
</span><span class='line'>    <span class="n">property</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">array</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span> <span class="n">integer</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">check</span> <span class="p">{</span> <span class="o">|</span><span class="n">vs</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ns</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">ds</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">ds</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">rs</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">ds</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">ds</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="n">vs</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It looks good:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">ruby</span> <span class="n">set_test</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">15625</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mi">119717</span><span class="n">s</span><span class="p">,</span> <span class="mi">33</span><span class="o">.</span><span class="mi">4121</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">1720</span><span class="o">.</span><span class="mi">7247</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">4</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">206</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>You then implement the removal of items:</p>

<figure class='code'><figcaption><span>&#8220;Set with delete&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-set-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DumbSet</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ls</span> <span class="o">=</span> <span class="n">storage</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="o">!</span><span class="n">ls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">ls</span><span class="o">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">v</span>
</span><span class='line'>        <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">&lt;&lt;</span> <span class="n">v</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">tail</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ns</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DumbSetTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:TestCase</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_delete</span>
</span><span class='line'>    <span class="n">os</span> <span class="o">=</span> <span class="p">(((</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">1337</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&lt;&lt;</span> <span class="mi">432</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">432</span><span class="o">]</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">432</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[]</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your tests pass, but this time you don&rsquo;t listen to me about adding another property. You&rsquo;re just not that convinced they&rsquo;re worth their salt, and it looks good enough to ship with all the tests you&rsquo;ve added. The PokÃ©mon Collecting app you work on can benefit from it right now, instead of 20 minutes from now. To production it goes.</p>

<p>Time goes by, and you&rsquo;ve forgotten about me and our little adventure. Your system is humming along and moved on to maintenance mode. Days have been kind of slow, so you decide to add an optimization you&rsquo;ve read about in Hacker News, detailing how a node.js program got a 10x speedup. You modify your delete method accordingly:</p>

<figure class='code'><figcaption><span>&#8220;Set Tests&#8221;</span><a href='https://gist.github.com/dodecaphonic/9934064#file-set_test-rb'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ls</span>  <span class="o">=</span> <span class="n">storage</span>
</span><span class='line'>    <span class="n">tmp</span> <span class="o">=</span> <span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="o">!</span><span class="n">ls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">head</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">)</span> <span class="c1"># secret performance trick</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">ls</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">tail</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">tmp</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>CI still reports all green.</p>

<p>A few days later, you receive a report from a User telling she deleted their PokÃ©mon with power level 3, but her PokÃ©mons with levels 4013, 1551 and 20000 disappeared. Your first line of defense &mdash; your tests &mdash; have not caught any issues. Sweating bullets and drowning in emails from stakeholders and other PokÃ©mon fiends, you&rsquo;re about to collapse.</p>

<p>And then you remember: what about trying to express a property to see if it holds?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># We&#39;ll add at most 10 unique items and then delete the first</span>
</span><span class='line'>  <span class="c1"># 2. If there&#39;s anything wrong, this will blow up.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_delete_property</span>
</span><span class='line'>    <span class="n">property</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">array</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">uniq</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">check</span> <span class="p">{</span> <span class="o">|</span><span class="n">values</span><span class="o">|</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">ds</span> <span class="o">=</span> <span class="n">values</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="n">os</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ds</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You run it and it explodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">ruby</span> <span class="n">set_test</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">46455</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">failure</span><span class="p">:</span> <span class="mi">0</span> <span class="n">tests</span><span class="p">,</span> <span class="ss">on</span><span class="p">:</span>
</span><span class='line'><span class="o">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">437</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">718</span><span class="p">,</span> <span class="mi">1850</span><span class="p">,</span> <span class="mi">4579</span><span class="p">,</span> <span class="mi">3178</span><span class="p">,</span> <span class="mi">4191</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">2669</span><span class="o">]</span>
</span><span class='line'><span class="n">F</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mi">093858</span><span class="n">s</span><span class="p">,</span> <span class="mi">63</span><span class="o">.</span><span class="mi">9264</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">2248</span><span class="o">.</span><span class="mo">076</span><span class="mi">9</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="ss">Failure</span><span class="p">:</span>
</span><span class='line'><span class="no">DumbSetTest</span><span class="c1">#test_delete_property [set_test.rb:69]:</span>
</span><span class='line'><span class="ss">Expected</span><span class="p">:</span> <span class="mi">8</span>
</span><span class='line'>  <span class="ss">Actual</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>
</span><span class='line'><span class="mi">6</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">211</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">1</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>What? How come you&rsquo;ve only got 2 when you expected 8? Well, there must be something wrong with delete, after all. Let&rsquo;s take that array and try it on an <em>pry</em> session to see what happens:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="o">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">437</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">718</span><span class="p">,</span> <span class="mi">1850</span><span class="p">,</span> <span class="mi">4579</span><span class="p">,</span> <span class="mi">3178</span><span class="p">,</span> <span class="mi">4191</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">2669</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="o">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">437</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">718</span><span class="p">,</span> <span class="mi">1850</span><span class="p">,</span> <span class="mi">4579</span><span class="p">,</span> <span class="mi">3178</span><span class="p">,</span> <span class="mi">4191</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">2669</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">DumbSet</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;DumbSet...&gt;</span>
</span><span class='line'><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="n">os</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="o">[</span><span class="mi">718</span><span class="p">,</span> <span class="mi">533</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wait a minute! Should delete also remove everything that&rsquo;s over 1000-ish? Is there anything in the code that stipulates such a thing? Maybe that node.js optimization was not so great after all. Let&rsquo;s remove it and run the tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">ruby</span> <span class="n">set_test</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">2727</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="ss">success</span><span class="p">:</span> <span class="mi">100</span> <span class="n">tests</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mi">099329</span><span class="n">s</span><span class="p">,</span> <span class="mi">60</span><span class="o">.</span><span class="mi">4053</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">3120</span><span class="o">.</span><span class="mi">9415</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">6</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">310</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>VoilÃ : properties have saved the day, and you&rsquo;ve learned not to trust Hacker News bravado ever again.</p>

<h2>Is using Rantly the same as using QuickCheck or ScalaCheck?</h2>

<p>Sort of. For one, you have to write your own generators every time you want something other than basic types, while both QuickCheck and ScalaCheck can figure out a lot by themselves. This can make expressing what you mean a lot easier, and you don&rsquo;t spend time debugging your <code>property</code> blocks in search of mistakes. That said, writing a generator for your own types requires only that you instantiate them in the <code>property</code> blocks with other auto-generated values.</p>

<p>Shrinking is not as good in Rantly. It works ok a lot of the time, but it could be improved. On the surface, from skimming the algorithms used in ScalaCheck and Rantly, it doesn&rsquo;t <em>seem</em> that different, but over that side of the line the patterns in minimization seem easier to spot.</p>

<p>There&rsquo;s also no mechanism to test stateful code. ScalaCheck has <a href="https://github.com/rickynils/scalacheck/wiki/User-Guide#stateful-testing">Commands</a> to help in modeling state changes, and I&rsquo;m aware <a href="https://github.com/manopapad/proper">PropEr</a> and [QuickCheck for Erlang][qcerlang] also provide something in that direction.</p>

<p>One minor thing is that integration with RSpec and MiniTest could be improved. Its output pollutes the test run, and on large suites it becomes hard to know the relationship between a failed property and a failed test. It should be easy to fix for anyone motivated. On that note, there&rsquo;s no ready-made extension for MiniTest (although adding one is trivial enough that I&rsquo;m sending a PR to fix it).</p>

<h2>Final considerations</h2>

<p>I hope I have proven, even if with a craptastic example, that property-testing can aid you in writing better Ruby code. Our community is great when it comes to using tests both as a design and as a verification tool, and QuickCheck (via Rantly) is a new way of thinking about them. You should keep your TDD/BDD to carve out your objects and responsibilities, but also add property checks where suitable to strengthen your confidence in the system.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Vitor Capela</span></span>

      








  


<time datetime="2014-04-02T10:32:00-03:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/fp/'>fp</a>, <a class='category' href='/blog/categories/haskell/'>haskell</a>, <a class='category' href='/blog/categories/quickcheck/'>quickcheck</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/scala/'>scala</a>, <a class='category' href='/blog/categories/testing/'>testing</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://troikatech.com/blog/2014/04/02/property-based-testing-in-ruby/" data-via="dodecaphonic" data-counturl="http://troikatech.com/blog/2014/04/02/property-based-testing-in-ruby/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/03/21/pt-br-palestra-sobre-celluloid-no-rubyonrio/" title="Previous Post: (PT-BR) Palestra sobre Celluloid no RubyOnRio">&laquo; (PT-BR) Palestra sobre Celluloid no RubyOnRio</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/02/property-based-testing-in-ruby/">Property-based Testing in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/21/pt-br-palestra-sobre-celluloid-no-rubyonrio/">(PT-BR) Palestra Sobre Celluloid No RubyOnRio</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/26/websocket-webmachine/">WebSockets in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/12/reactive/">"Principles of Reactive Programming", a Review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/15/rework/">"REWORK", by 37signals &mdash; &#9733;&#9733;&#9734;&#9734;&#9734;</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dodecaphonic">@dodecaphonic</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dodecaphonic',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+VitorCapela?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Vitor Capela -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
